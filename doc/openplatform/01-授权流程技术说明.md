# 01-授权流程技术说明

## 概述

微信开放平台第三方平台授权流程是第三方平台与公众号/小程序建立授权关系的关键流程。WeGo库提供了完整的授权流程实现，完全符合微信官方文档规范。<mcreference link="https://developers.weixin.qq.com/doc/oplatform/Third-party_Platforms/2.0/api/Before_Develop/Authorization_Process_Technical_Description.html" index="0">0</mcreference>

## 授权流程步骤

### 1. 配置权限集与开发资料

前往微信开放平台-第三方平台-详情-开发配置，完成权限集与开发资料的配置。<mcreference link="https://developers.weixin.qq.com/doc/oplatform/Third-party_Platforms/2.0/api/Before_Develop/Authorization_Process_Technical_Description.html" index="0">0</mcreference>

### 2. 获取预授权码

预授权码用于生成授权页面的URL，有效期为20分钟。<mcreference link="https://developers.weixin.qq.com/doc/oplatform/Third-party_Platforms/2.0/api/Before_Develop/Authorization_Process_Technical_Description.html" index="0">0</mcreference>

```go
// 获取预授权码
func (c *APIClient) GetPreAuthCode(ctx context.Context) (*PreAuthCodeResponse, error)

// 示例代码
preAuthCodeResp, err := client.GetPreAuthCode(context.Background())
if err != nil {
    // 处理错误
}

fmt.Printf("预授权码: %s, 有效期: %d秒\n", preAuthCodeResp.PreAuthCode, preAuthCodeResp.ExpiresIn)
```

### 3. 生成授权页面URL

使用预授权码生成授权页面URL，引导用户进行授权。支持多种授权类型配置。<mcreference link="https://developers.weixin.qq.com/doc/oplatform/Third-party_Platforms/2.0/api/Before_Develop/Authorization_Process_Technical_Description.html" index="0">0</mcreference>

```go
// 生成授权页面URL
func (c *APIClient) GenerateAuthURL(preAuthCode string, authType int, bizAppID string, platform string) string

// 生成PC端授权链接
func (c *APIClient) GeneratePcAuthURL(preAuthCode string, authType int, bizAppID string) string

// 生成移动端授权链接
func (c *APIClient) GenerateMobileAuthURL(preAuthCode string, authType int, bizAppID string) string

// 示例代码 - PC端基本授权
authURL := client.GeneratePcAuthURL(
    preAuthCodeResp.PreAuthCode, 
    3, // auth_type: 3表示公众号和小程序都展示
    ""  // biz_appid: 空表示不指定特定公众号/小程序
)
fmt.Printf("PC端授权页面URL: %s\n", authURL)

// 示例代码 - 移动端授权
mobileAuthURL := client.GenerateMobileAuthURL(
    preAuthCodeResp.PreAuthCode,
    3, // auth_type: 3表示公众号和小程序都展示
    ""  // biz_appid: 空表示不指定特定公众号/小程序
)
fmt.Printf("移动端授权页面URL: %s\n", mobileAuthURL)

// 示例代码 - 使用通用方法生成授权URL
authURL2 := client.GenerateAuthURL(
    preAuthCodeResp.PreAuthCode,
    3, // auth_type: 3表示公众号和小程序都展示
    "", // biz_appid: 空表示不指定特定公众号/小程序
    "pc" // platform: "pc"表示PC端，"mobile"表示移动端
)
fmt.Printf("通用方法生成的授权URL: %s\n", authURL2)
```

**授权类型参数说明：**<mcreference link="https://developers.weixin.qq.com/doc/oplatform/Third-party_Platforms/2.0/api/Before_Develop/Authorization_Process_Technical_Description.html" index="0">0</mcreference>
- `1`：手机端仅展示公众号
- `2`：仅展示小程序
- `3`：公众号和小程序都展示
- `4`：小程序推客账号
- `5`：视频号账号
- `6`：全部（公众号、小程序、视频号都展示）
- `8`：带货助手账号

**重要说明：**<mcreference link="https://developers.weixin.qq.com/doc/oplatform/Third-party_Platforms/2.0/api/Before_Develop/Authorization_Process_Technical_Description.html" index="0">0</mcreference>
- 对于已经注销、冻结、封禁、以及未完成注册的账号不再出现于授权账号列表
- 如果指定了biz_appid，则只能是该appid的管理员进行授权，其他用户扫码会出现报错
- auth_type、biz_appid 两个字段如果设置的信息冲突，则biz_appid生效的优先级更高

**授权页面类型说明：**<mcreference link="https://developers.weixin.qq.com/doc/oplatform/Third-party_Platforms/2.0/api/Before_Develop/Authorization_Process_Technical_Description.html" index="0">0</mcreference>
- **PC端授权页面**：适用于网页扫码授权，生成二维码供用户扫描，URL格式：`https://mp.weixin.qq.com/cgi-bin/componentloginpage`
- **移动端授权页面**：适用于直接在手机浏览器中打开授权，URL格式：`https://open.weixin.qq.com/connect/oauth2/authorize`
- WeGo库提供完整的PC端和移动端授权页面生成支持

### 4. 用户授权确认

公众号/小程序管理员扫码或者访问移动端授权链接，确认同意授权给第三方平台。<mcreference link="https://developers.weixin.qq.com/doc/oplatform/Third-party_Platforms/2.0/api/Before_Develop/Authorization_Process_Technical_Description.html" index="0">0</mcreference>

### 5. 处理授权回调

用户授权后，微信会回调到指定的redirect_uri，并携带授权码和过期时间（redirect_url?auth_code=xxx&expires_in=600）。<mcreference link="https://developers.weixin.qq.com/doc/oplatform/Third-party_Platforms/2.0/api/Before_Develop/Authorization_Process_Technical_Description.html" index="0">0</mcreference>

```go
// 使用授权码换取授权信息
func (c *APIClient) QueryAuth(ctx context.Context, authorizationCode string) (*QueryAuthResponse, error)

// 示例代码 - 处理授权回调
authCode := "从回调URL中获取的授权码"
queryAuthResponse, err := client.QueryAuth(context.Background(), authCode)
if err != nil {
    // 处理错误
    log.Printf("换取授权信息失败: %v", err)
    return
}

authorizationInfo := queryAuthResponse.AuthorizationInfo
fmt.Printf("授权方AppID: %s\n", authorizationInfo.AuthorizerAppID)
fmt.Printf("授权方AccessToken: %s\n", authorizationInfo.AuthorizerAccessToken)
fmt.Printf("授权方RefreshToken: %s\n", authorizationInfo.AuthorizerRefreshToken)
fmt.Printf("授权码过期时间: %d秒\n", authorizationInfo.ExpiresIn)

// 注意：授权码有效期为10分钟，需要及时处理
if authorizationInfo.ExpiresIn < 300 { // 剩余时间小于5分钟
    log.Printf("警告：授权码即将过期，剩余时间: %d秒", authorizationInfo.ExpiresIn)
}
```

**授权回调参数说明：**<mcreference link="https://developers.weixin.qq.com/doc/oplatform/Third-party_Platforms/2.0/api/Before_Develop/Authorization_Process_Technical_Description.html" index="0">0</mcreference>
- `auth_code`：授权码，用于换取授权信息
- `expires_in`：授权码过期时间，单位秒（通常为600秒，即10分钟）

**重要注意事项：**
1. **时效性**：授权码有效期为10分钟，必须在有效期内完成QueryAuth调用
2. **错误处理**：QueryAuth可能返回各种错误码，需要完善错误处理逻辑
3. **Token缓存**：WeGo库会自动缓存授权方token，无需手动管理
4. **重试机制**：网络异常时建议实现重试机制

### 6. 获取授权方信息

获取授权方的详细信息，包括昵称、头像、服务类型、权限集等。<mcreference link="https://developers.weixin.qq.com/doc/oplatform/Third-party_Platforms/2.0/api/Before_Develop/Authorization_Process_Technical_Description.html" index="0">0</mcreference>

```go
// 获取授权方信息
func (c *APIClient) GetAuthorizerInfo(ctx context.Context, authorizerAppID string) (*GetAuthorizerInfoResponse, error)

// 示例代码
authorizerInfoResp, err := client.GetAuthorizerInfo(context.Background(), authorizationInfo.AuthorizerAppID)
if err != nil {
    // 处理错误
}

authorizerInfo := authorizerInfoResp.AuthorizerInfo
fmt.Printf("授权方昵称: %s\n", authorizerInfo.NickName)
fmt.Printf("授权方头像: %s\n", authorizerInfo.HeadImg)
fmt.Printf("服务类型: %d\n", authorizerInfo.ServiceTypeInfo.ID)
fmt.Printf("验证类型: %d\n", authorizerInfo.VerifyTypeInfo.ID)

// 输出授权权限集
for _, funcInfo := range authorizerInfo.FuncInfo {
    fmt.Printf("权限集ID: %d\n", funcInfo.FuncscopeCategory.ID)
}
```

## WeGo库实现

### 核心结构体

```go
// OpenPlatformClient 微信开放平台客户端
type OpenPlatformClient struct {
    config     *OpenPlatformConfig
    httpClient HTTPClient
    storage    storage.TokenStorage
    logger     Logger
}

// AuthorizerClient 授权方客户端
type AuthorizerClient struct {
    authClient      *AuthClient
    authorizerAppID string
}
```

### 配置说明

```go
type OpenPlatformConfig struct {
    ComponentAppID     string `json:"component_app_id"`     // 第三方平台appid
    ComponentAppSecret string `json:"component_app_secret"` // 第三方平台appsecret
    ComponentToken     string `json:"component_token"`      // 消息校验Token
    EncodingAESKey     string `json:"encoding_aes_key"`     // 消息加解密Key
    RedirectURI        string `json:"redirect_uri"`         // 授权回调URI
}
```

## 完整示例

```go
package main

import (
    "context"
    "fmt"
    "log"
    "time"
    "github.com/jcbowen/wego"
)

func main() {
    // 1. 初始化客户端
    config := &wego.OpenPlatformConfig{
        ComponentAppID:     "your_component_app_id",
        ComponentAppSecret: "your_component_app_secret",
        ComponentToken:     "your_component_token", 
        EncodingAESKey:     "your_encoding_aes_key",
        RedirectURI:        "https://yourdomain.com/auth/callback",
    }
    
    client := wego.NewOpenPlatformClient(config)
    
    ctx, cancel := context.WithTimeout(context.Background(), 10*time.Second)
    defer cancel()
    
    // 2. 获取预授权码
    preAuthCodeResp, err := client.GetPreAuthCode(ctx)
    if err != nil {
        log.Printf("获取预授权码失败: %v\n", err)
        return
    }
    
    // 3. 生成授权页面URL（PC端）
    authURL := client.GeneratePcAuthURL(
        preAuthCodeResp.PreAuthCode, 
        3, // auth_type: 3表示公众号和小程序都展示
        ""  // biz_appid: 空表示不指定特定公众号/小程序
    )
    fmt.Printf("请访问以下URL进行授权: %s\n", authURL)
    
    // 生成移动端授权页面URL
    mobileAuthURL := client.GenerateMobileAuthURL(
        preAuthCodeResp.PreAuthCode,
        3, // auth_type: 3表示公众号和小程序都展示
        ""  // biz_appid: 空表示不指定特定公众号/小程序
    )
    fmt.Printf("移动端授权URL: %s\n", mobileAuthURL)
    
    // 4. 处理授权回调（在实际应用中，这通常在HTTP处理函数中）
    // authCode := r.URL.Query().Get("auth_code")
    // queryAuthResponse, err := client.QueryAuth(ctx, authCode)
    // if err != nil {
    //     log.Printf("换取授权信息失败: %v", err)
    //     return
    // }
    // authorizationInfo := queryAuthResponse.AuthorizationInfo
    // fmt.Printf("授权方AppID: %s\n", authorizationInfo.AuthorizerAppID)
    
    // 5. 获取授权方详细信息
    // authorizerInfo, err := client.GetAuthorizerInfo(ctx, authorizationInfo.AuthorizerAppID)
    // if err != nil {
    //     log.Printf("获取授权方信息失败: %v", err)
    //     return
    // }
    // fmt.Printf("授权方昵称: %s\n", authorizerInfo.NickName)
}
```

## 注意事项

1. **预授权码有效期**：预授权码有效期为20分钟，需要及时使用
2. **授权回调处理**：确保回调地址可公开访问且正确处理HTTPS
3. **Token管理**：授权方AccessToken有效期为2小时，需要定时刷新
4. **安全考虑**：妥善保管ComponentAppSecret和EncodingAESKey
5. **上下文管理**：所有API调用都需要传入context.Context参数，支持超时和取消

## 常见问题

### Q: 授权页面显示"redirect_uri参数错误"
A: 请检查在微信开放平台配置的授权回调域名与代码中使用的redirect_uri是否一致

### Q: 获取预授权码失败
A: 请检查ComponentAppID和ComponentAppSecret是否正确，以及网络连接是否正常

### Q: 授权回调处理失败
A: 请检查回调处理逻辑是否正确，以及授权码是否在有效期内

### Q: 如何设置自定义存储
A: 使用`wego.NewWeGoWithStorage(config, storage)`创建客户端，传入自定义的TokenStorage实现

## 相关API

- `GetPreAuthCode(ctx context.Context) (*PreAuthCodeResponse, error)` - 获取预授权码
- `GenerateAuthURL(preAuthCode string, authType int, bizAppID string, platform string) string` - 生成授权页面URL（通用方法）
- `GeneratePcAuthURL(preAuthCode string, authType int, bizAppID string) string` - 生成PC端授权页面URL
- `GenerateMobileAuthURL(preAuthCode string, authType int, bizAppID string) string` - 生成移动端授权页面URL
- `QueryAuth(ctx context.Context, authorizationCode string) (*QueryAuthResponse, error)` - 使用授权码换取授权信息
- `GetAuthorizerInfo(ctx context.Context, authorizerAppID string) (*GetAuthorizerInfoResponse, error)` - 获取授权方详细信息
- `GetAuthorizerOption(ctx context.Context, authorizerAppID, optionName string) (*GetAuthorizerOptionResponse, error)` - 获取授权方选项设置
- `SetAuthorizerOption(ctx context.Context, authorizerAppID, optionName, optionValue string) (*APIResponse, error)` - 设置授权方选项
- `RefreshAuthorizerToken(ctx context.Context, authorizerAppID, refreshToken string) (*AuthorizerTokenResponse, error)` - 刷新授权方access_token
- `GetAuthorizerList(ctx context.Context, offset, count int) (*GetAuthorizerListResponse, error)` - 获取授权方列表

通过WeGo库，您可以轻松实现完整的微信开放平台第三方平台授权流程。