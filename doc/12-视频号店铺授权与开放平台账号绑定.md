# 视频号店铺授权与开放平台账号绑定

本文档介绍如何使用jcbaseGo的wxopen组件实现视频号店铺授权管理和开放平台账号绑定功能。

## 功能概述

wxopen组件提供了完整的视频号店铺授权和开放平台账号绑定API，包括：

- ✅ **视频号小店商家信息管理** - 获取和更新商家信息
- ✅ **视频号小店注册** - 注册视频号小店
- ✅ **回调配置管理** - 设置和获取回调配置
- ✅ **订单管理** - 获取订单详情和列表
- ✅ **商品管理** - 商品添加、查询和管理
- ✅ **发货管理** - 订单发货处理
- ✅ **开放平台账号绑定** - 创建、绑定、解绑开放平台账号

## 视频号店铺授权API

### 1. 获取商家信息

获取视频号小店的商家信息，包括客服配置、退货地址等。

```go
// 获取商家信息
func (c *AuthorizerClient) GetShopAccountInfo(ctx context.Context) (*ShopAccountResponse, error)

// 示例代码
client := NewAuthorizerClient(wxOpenClient, "authorizer_appid")
result, err := client.GetShopAccountInfo(context.Background())
if err != nil {
    log.Printf("获取商家信息失败: %v", err)
    return
}

fmt.Printf("客服路径: %s\n", result.Data.ServiceAgentPath)
fmt.Printf("客服电话: %s\n", result.Data.ServiceAgentPhone)
fmt.Printf("客服类型: %v\n", result.Data.ServiceAgentType)
```

### 2. 更新商家信息

更新视频号小店的商家信息。

```go
// 更新商家信息
func (c *AuthorizerClient) UpdateShopAccountInfo(ctx context.Context, request *ShopAccountUpdateRequest) error

// 示例代码
updateRequest := &ShopAccountUpdateRequest{
    ServiceAgentPath:  "pages/customer-service/index",
    ServiceAgentPhone: "400-123-4567",
    ServiceAgentType:  []int{0, 1, 2},
    DefaultReceivingAddress: &ReceivingAddress{
        ReceiverName:    "张三",
        DetailedAddress: "广东省深圳市南山区科技园",
        TelNumber:       "13800138000",
        Province:        "广东省",
        City:            "深圳市",
    },
}

err := client.UpdateShopAccountInfo(context.Background(), updateRequest)
if err != nil {
    log.Printf("更新商家信息失败: %v", err)
    return
}
fmt.Println("商家信息更新成功")
```

### 3. 注册视频号小店

注册视频号小店，获取小店专用的access_token。

```go
// 注册视频号小店
func (c *AuthorizerClient) RegisterShop(ctx context.Context) (*ShopRegisterResponse, error)

// 示例代码
result, err := client.RegisterShop(context.Background())
if err != nil {
    log.Printf("注册视频号小店失败: %v", err)
    return
}

fmt.Printf("小店AccessToken: %s\n", result.Data.AccessToken)
fmt.Printf("过期时间: %d秒\n", result.Data.ExpireIn)
```

### 4. 回调配置管理

设置和获取视频号小店的消息回调配置。

```go
// 设置回调配置
func (c *AuthorizerClient) SetShopCallback(ctx context.Context, config *ShopCallbackConfig) error

// 获取回调配置
func (c *AuthorizerClient) GetShopCallback(ctx context.Context) (*ShopCallbackConfig, error)

// 示例代码 - 设置回调
callbackConfig := &ShopCallbackConfig{
    URL:   "https://your-domain.com/shop/callback",
    Token: "your_token",
    Key:   "your_encoding_aes_key",
}

err := client.SetShopCallback(context.Background(), callbackConfig)
if err != nil {
    log.Printf("设置回调配置失败: %v", err)
    return
}
fmt.Println("回调配置设置成功")

// 示例代码 - 获取回调
config, err := client.GetShopCallback(context.Background())
if err != nil {
    log.Printf("获取回调配置失败: %v", err)
    return
}
fmt.Printf("回调URL: %s\n", config.URL)
```

### 5. 订单管理

获取订单详情和订单列表。

```go
// 获取订单详情
func (c *AuthorizerClient) GetShopOrder(ctx context.Context, orderID string) (*ShopOrderResponse, error)

// 获取订单列表
func (c *AuthorizerClient) GetShopOrderList(ctx context.Context, page, pageSize int) (*ShopOrderListResponse, error)

// 示例代码 - 获取订单详情
order, err := client.GetShopOrder(context.Background(), "order_123456")
if err != nil {
    log.Printf("获取订单详情失败: %v", err)
    return
}

fmt.Printf("订单ID: %s\n", order.Data.OrderID)
fmt.Printf("订单状态: %d\n", order.Data.Status)
fmt.Printf("订单金额: %d\n", order.Data.TotalAmount)

// 示例代码 - 获取订单列表
orders, err := client.GetShopOrderList(context.Background(), 1, 10)
if err != nil {
    log.Printf("获取订单列表失败: %v", err)
    return
}

fmt.Printf("总订单数: %d\n", orders.Total)
for _, order := range orders.Data {
    fmt.Printf("订单ID: %s, 状态: %d, 金额: %d\n", 
        order.OrderID, order.Status, order.TotalAmount)
}
```

### 6. 商品管理

管理视频号小店的商品，包括添加商品、获取商品详情和商品列表。

```go
// 获取商品详情
func (c *AuthorizerClient) GetShopProduct(ctx context.Context, productID string) (*ShopProductResponse, error)

// 获取商品列表
func (c *AuthorizerClient) GetShopProductList(ctx context.Context, page, pageSize int) (*ShopProductListResponse, error)

// 添加商品
func (c *AuthorizerClient) AddShopProduct(ctx context.Context, request *ShopProductAddRequest) (*ShopProductResponse, error)

// 示例代码 - 添加商品
productRequest := &ShopProductAddRequest{
    Title:       "测试商品",
    Price:       100, // 单位：分
    Stock:       100,
    Description: "这是一个测试商品",
    Images:      []string{"https://example.com/image1.jpg"},
}

result, err := client.AddShopProduct(context.Background(), productRequest)
if err != nil {
    log.Printf("添加商品失败: %v", err)
    return
}

fmt.Printf("商品添加成功，商品ID: %s\n", result.Data.ProductID)
```

### 7. 发货管理

处理视频号小店订单的发货操作。

```go
// 订单发货
func (c *AuthorizerClient) DeliverShopOrder(ctx context.Context, orderID, logisticsCompany, trackingNumber string) error

// 示例代码
err := client.DeliverShopOrder(context.Background(), 
    "order_123456", 
    "顺丰速运", 
    "SF1234567890")
if err != nil {
    log.Printf("订单发货失败: %v", err)
    return
}
fmt.Println("订单发货成功")
```

## 开放平台账号绑定API

### 1. 创建开放平台账号

为公众号/小程序创建开放平台账号并绑定。

```go
// 创建开放平台账号
func (c *AuthorizerClient) CreateOpenAccount(ctx context.Context) (*OpenAccountResponse, error)

// 示例代码
result, err := client.CreateOpenAccount(context.Background())
if err != nil {
    log.Printf("创建开放平台账号失败: %v", err)
    return
}

fmt.Printf("开放平台AppID: %s\n", result.OpenAppID)
```

### 2. 绑定到已有开放平台账号

将公众号/小程序绑定到已有的开放平台账号。

```go
// 绑定开放平台账号
func (c *AuthorizerClient) BindOpenAccount(ctx context.Context, openAppID string) error

// 示例代码
err := client.BindOpenAccount(context.Background(), "open_appid_123456")
if err != nil {
    log.Printf("绑定开放平台账号失败: %v", err)
    return
}
fmt.Println("绑定开放平台账号成功")
```

### 3. 解绑开放平台账号

解绑公众号/小程序与开放平台账号的绑定关系。

```go
// 解绑开放平台账号
func (c *AuthorizerClient) UnbindOpenAccount(ctx context.Context, openAppID string) error

// 示例代码
err := client.UnbindOpenAccount(context.Background(), "open_appid_123456")
if err != nil {
    log.Printf("解绑开放平台账号失败: %v", err)
    return
}
fmt.Println("解绑开放平台账号成功")
```

### 4. 获取绑定的开放平台账号

获取公众号/小程序所绑定的开放平台账号信息。

```go
// 获取开放平台账号
func (c *AuthorizerClient) GetOpenAccount(ctx context.Context) (*OpenAccountResponse, error)

// 示例代码
result, err := client.GetOpenAccount(context.Background())
if err != nil {
    log.Printf("获取开放平台账号失败: %v", err)
    return
}

fmt.Printf("绑定的开放平台AppID: %s\n", result.OpenAppID)
```

## 完整示例

### 视频号小店管理完整示例

```go
package main

import (
    "context"
    "fmt"
    "log"
    "time"
    
    "github.com/jcbowen/jcbaseGo/component/wego"
)

func main() {
    // 初始化微信开放平台客户端
    config := &wego.WxOpenConfig{
        ComponentAppID:     "your_component_appid",
        ComponentAppSecret: "your_component_appsecret",
        ComponentToken:     "your_component_token",
        EncodingAESKey:     "your_encoding_aes_key",
    }
    
    client := wego.NewWxOpenClient(config)
    
    // 创建授权方客户端
    authorizerClient := wego.NewAuthorizerClient(client, "authorizer_appid")
    
    ctx, cancel := context.WithTimeout(context.Background(), 10*time.Second)
    defer cancel()
    
    // 1. 获取商家信息
    accountInfo, err := authorizerClient.GetShopAccountInfo(ctx)
    if err != nil {
        log.Printf("获取商家信息失败: %v", err)
        return
    }
    fmt.Printf("商家信息: %+v\n", accountInfo.Data)
    
    // 2. 获取订单列表
    orders, err := authorizerClient.GetShopOrderList(ctx, 1, 10)
    if err != nil {
        log.Printf("获取订单列表失败: %v", err)
        return
    }
    
    fmt.Printf("总订单数: %d\n", orders.Total)
    for _, order := range orders.Data {
        fmt.Printf("订单: %s, 状态: %d, 金额: %d\n", 
            order.OrderID, order.Status, order.TotalAmount)
    }
    
    // 3. 获取开放平台账号信息
    openAccount, err := authorizerClient.GetOpenAccount(ctx)
    if err != nil {
        log.Printf("获取开放平台账号失败: %v", err)
        return
    }
    fmt.Printf("开放平台AppID: %s\n", openAccount.OpenAppID)
}
```

## 错误处理

所有API方法都返回标准的错误信息，可以通过检查返回的APIResponse来判断操作是否成功：

```go
result, err := client.GetShopAccountInfo(ctx)
if err != nil {
    if apiErr, ok := err.(*wego.APIResponse); ok {
        fmt.Printf("API错误: %d - %s\n", apiErr.ErrCode, apiErr.ErrMsg)
    } else {
        fmt.Printf("其他错误: %v\n", err)
    }
    return
}
```

## 注意事项

1. **权限要求**: 视频号小店API需要小程序或公众号具备相应的权限
2. **频率限制**: 注意API调用频率限制，避免触发限流
3. **Token管理**: 确保access_token的有效性，及时刷新过期的token
4. **错误处理**: 正确处理各种错误情况，包括网络错误和API错误
5. **数据验证**: 在调用API前验证输入参数的合法性

## 常见问题

### Q: 如何获取视频号小店的access_token？
A: 通过`RegisterShop`方法注册视频号小店后，会返回小店专用的access_token。

### Q: 开放平台账号绑定有什么作用？
A: 绑定开放平台账号后，可以获取用户的unionid，实现跨公众号、小程序、移动应用的用户识别。

### Q: 视频号小店回调配置有什么作用？
A: 回调配置用于接收视频号小店的各种事件通知，如订单创建、支付成功等。

### Q: 如何处理API调用频率限制？
A: 建议实现重试机制，在遇到频率限制错误时等待一段时间后重试。

## 技术支持

如果在使用过程中遇到问题，可以参考：

1. 微信开放平台官方文档
2. 组件源代码中的注释和示例
3. 其他相关技术文档

通过本文档介绍的API，您可以轻松实现视频号店铺的完整管理功能，包括商家信息管理、订单处理、商品管理等核心业务功能。