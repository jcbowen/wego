# 03-æˆæƒå˜æ›´é€šçŸ¥æ¨é€

## æ¦‚è¿°

æˆæƒå˜æ›´é€šçŸ¥æ¨é€æ˜¯å¾®ä¿¡å¼€æ”¾å¹³å°åœ¨æˆæƒçŠ¶æ€å‘ç”Ÿå˜åŒ–æ—¶ï¼Œå‘ç¬¬ä¸‰æ–¹å¹³å°æ¨é€çš„äº‹ä»¶é€šçŸ¥ã€‚WeGoåº“æä¾›äº†å®Œæ•´çš„äº‹ä»¶å¤„ç†æœºåˆ¶ï¼Œæ”¯æŒå¤šç§æˆæƒå˜æ›´äº‹ä»¶çš„æ¥æ”¶å’Œå¤„ç†ã€‚

## äº‹ä»¶ç±»å‹

### 1. æˆæƒæˆåŠŸäº‹ä»¶ (authorized)
å½“å…¬ä¼—å·/å°ç¨‹åºæˆæƒç»™ç¬¬ä¸‰æ–¹å¹³å°æ—¶è§¦å‘ã€‚

### 2. å–æ¶ˆæˆæƒäº‹ä»¶ (unauthorized)  
å½“å…¬ä¼—å·/å°ç¨‹åºå–æ¶ˆæˆæƒæ—¶è§¦å‘ã€‚

### 3. æˆæƒæ›´æ–°äº‹ä»¶ (updateauthorized)
å½“æˆæƒæ–¹æ›´æ–°æˆæƒæ—¶è§¦å‘ã€‚

## äº‹ä»¶æ¨é€æ ¼å¼

### XMLæ ¼å¼ç¤ºä¾‹

```xml
<!-- æˆæƒæˆåŠŸäº‹ä»¶ -->
<xml>
  <AppId><![CDATA[ç¬¬ä¸‰æ–¹å¹³å°AppID]]></AppId>
  <CreateTime>1413192760</CreateTime>
  <InfoType><![CDATA[authorized]]></InfoType>
  <AuthorizerAppid><![CDATA[æˆæƒæ–¹AppID]]></AuthorizerAppid>
  <AuthorizationCode><![CDATA[æˆæƒç ]]></AuthorizationCode>
  <AuthorizationCodeExpiredTime>1413196360</AuthorizationCodeExpiredTime>
  <PreAuthCode><![CDATA[é¢„æˆæƒç ]]></PreAuthCode>
</xml>

<!-- å–æ¶ˆæˆæƒäº‹ä»¶ -->
<xml>
  <AppId><![CDATA[ç¬¬ä¸‰æ–¹å¹³å°AppID]]></AppId>
  <CreateTime>1413192760</CreateTime>
  <InfoType><![CDATA[unauthorized]]></InfoType>
  <AuthorizerAppid><![CDATA[æˆæƒæ–¹AppID]]></AuthorizerAppid>
</xml>

<!-- æˆæƒæ›´æ–°äº‹ä»¶ -->
<xml>
  <AppId><![CDATA[ç¬¬ä¸‰æ–¹å¹³å°AppID]]></AppId>
  <CreateTime>1413192760</CreateTime>
  <InfoType><![CDATA[updateauthorized]]></InfoType>
  <AuthorizerAppid><![CDATA[æˆæƒæ–¹AppID]]></AuthorizerAppid>
  <AuthorizationCode><![CDATA[æˆæƒç ]]></AuthorizationCode>
  <AuthorizationCodeExpiredTime>1413196360</AuthorizationCodeExpiredTime>
  <PreAuthCode><![CDATA[é¢„æˆæƒç ]]></PreAuthCode>
</xml>
```

## wxopenç»„ä»¶å®ç°

### äº‹ä»¶å¤„ç†å™¨æ¥å£

wxopenç»„ä»¶å®šä¹‰äº†äº‹ä»¶å¤„ç†å™¨æ¥å£ï¼Œæ”¯æŒè‡ªå®šä¹‰äº‹ä»¶å¤„ç†é€»è¾‘ï¼š

```go
// EventHandler äº‹ä»¶å¤„ç†å™¨æ¥å£
type EventHandler interface {
    // å¤„ç†æˆæƒæˆåŠŸäº‹ä»¶
    HandleAuthorized(event *AuthorizedEvent) error
    
    // å¤„ç†å–æ¶ˆæˆæƒäº‹ä»¶  
    HandleUnauthorized(event *UnauthorizedEvent) error
    
    // å¤„ç†æˆæƒæ›´æ–°äº‹ä»¶
    HandleUpdateAuthorized(event *UpdateAuthorizedEvent) error
}

// é»˜è®¤äº‹ä»¶å¤„ç†å™¨
type DefaultEventHandler struct{}

func (h *DefaultEventHandler) HandleAuthorized(event *AuthorizedEvent) error {
    fmt.Printf("æˆæƒæˆåŠŸ: AppID=%s, æˆæƒç =%s\n", 
        event.AuthorizerAppid, event.AuthorizationCode)
    
    // è‡ªåŠ¨è·å–æˆæƒä¿¡æ¯å¹¶å­˜å‚¨
    // ...
    
    return nil
}

func (h *DefaultEventHandler) HandleUnauthorized(event *UnauthorizedEvent) error {
    fmt.Printf("å–æ¶ˆæˆæƒ: AppID=%s\n", event.AuthorizerAppid)
    
    // æ¸…ç†ç›¸å…³æ•°æ®
    // ...
    
    return nil
}

func (h *DefaultEventHandler) HandleUpdateAuthorized(event *UpdateAuthorizedEvent) error {
    fmt.Printf("æˆæƒæ›´æ–°: AppID=%s, æˆæƒç =%s\n",
        event.AuthorizerAppid, event.AuthorizationCode)
    
    // æ›´æ–°æˆæƒä¿¡æ¯
    // ...
    
    return nil
}
```

### äº‹ä»¶å¤„ç†æµç¨‹

```go
// å¤„ç†æˆæƒå˜æ›´äº‹ä»¶
func (client *WxOpenClient) HandleAuthorizationEvent(msg *Message) (*MessageResponse, error) {
    switch msg.InfoType {
    case "authorized":
        event := &AuthorizedEvent{
            AuthorizerAppid:            msg.AuthorizerAppid,
            AuthorizationCode:          msg.AuthorizationCode,
            AuthorizationCodeExpiredTime: msg.AuthorizationCodeExpiredTime,
            PreAuthCode:                msg.PreAuthCode,
        }
        
        if err := client.eventHandler.HandleAuthorized(event); err != nil {
            return nil, fmt.Errorf("å¤„ç†æˆæƒæˆåŠŸäº‹ä»¶å¤±è´¥: %v", err)
        }
        
    case "unauthorized":
        event := &UnauthorizedEvent{
            AuthorizerAppid: msg.AuthorizerAppid,
        }
        
        if err := client.eventHandler.HandleUnauthorized(event); err != nil {
            return nil, fmt.Errorf("å¤„ç†å–æ¶ˆæˆæƒäº‹ä»¶å¤±è´¥: %v", err)
        }
        
    case "updateauthorized":
        event := &UpdateAuthorizedEvent{
            AuthorizerAppid:            msg.AuthorizerAppid,
            AuthorizationCode:          msg.AuthorizationCode,
            AuthorizationCodeExpiredTime: msg.AuthorizationCodeExpiredTime,
            PreAuthCode:                msg.PreAuthCode,
        }
        
        if err := client.eventHandler.HandleUpdateAuthorized(event); err != nil {
            return nil, fmt.Errorf("å¤„ç†æˆæƒæ›´æ–°äº‹ä»¶å¤±è´¥: %v", err)
        }
        
    default:
        return nil, fmt.Errorf("æœªçŸ¥çš„äº‹ä»¶ç±»å‹: %s", msg.InfoType)
    }
    
    return &MessageResponse{
        ErrCode: 0,
        ErrMsg:  "ok",
    }, nil
}
```

## å®Œæ•´ç¤ºä¾‹

### 1. è‡ªå®šä¹‰äº‹ä»¶å¤„ç†å™¨

```go
package main

import (
    "fmt"
    "github.com/jcbowen/wego"
)

// è‡ªå®šä¹‰äº‹ä»¶å¤„ç†å™¨
type MyEventHandler struct {
    db *sql.DB // å‡è®¾æœ‰æ•°æ®åº“è¿æ¥
}

func (h *MyEventHandler) HandleAuthorized(event *wego.AuthorizedEvent) error {
    fmt.Printf("ğŸ‰ æ–°çš„æˆæƒæˆåŠŸ: %s\n", event.AuthorizerAppid)
    
    // 1. ä½¿ç”¨æˆæƒç è·å–æˆæƒä¿¡æ¯
    authInfo, err := h.client.QueryAuth(event.AuthorizationCode)
    if err != nil {
        return fmt.Errorf("è·å–æˆæƒä¿¡æ¯å¤±è´¥: %v", err)
    }
    
    // 2. è·å–æˆæƒæ–¹è¯¦ç»†ä¿¡æ¯
    authorizerInfo, err := h.client.GetAuthorizerInfo(event.AuthorizerAppid)
    if err != nil {
        return fmt.Errorf("è·å–æˆæƒæ–¹ä¿¡æ¯å¤±è´¥: %v", err)
    }
    
    // 3. å­˜å‚¨åˆ°æ•°æ®åº“
    err = h.saveAuthorization(authInfo, authorizerInfo)
    if err != nil {
        return fmt.Errorf("å­˜å‚¨æˆæƒä¿¡æ¯å¤±è´¥: %v", err)
    }
    
    fmt.Printf("âœ… æˆæƒæ–¹ %s ä¿¡æ¯å·²ä¿å­˜\n", authorizerInfo.NickName)
    return nil
}

func (h *MyEventHandler) HandleUnauthorized(event *wego.UnauthorizedEvent) error {
    fmt.Printf("âš ï¸ å–æ¶ˆæˆæƒ: %s\n", event.AuthorizerAppid)
    
    // æ¸…ç†ç›¸å…³æ•°æ®
    err := h.cleanupAuthorization(event.AuthorizerAppid)
    if err != nil {
        return fmt.Errorf("æ¸…ç†æˆæƒæ•°æ®å¤±è´¥: %v", err)
    }
    
    fmt.Printf("âœ… æˆæƒæ–¹ %s æ•°æ®å·²æ¸…ç†\n", event.AuthorizerAppid)
    return nil
}

func (h *MyEventHandler) HandleUpdateAuthorized(event *wego.UpdateAuthorizedEvent) error {
    fmt.Printf("ğŸ”„ æˆæƒæ›´æ–°: %s\n", event.AuthorizerAppid)
    
    // é‡æ–°è·å–æˆæƒä¿¡æ¯
    authInfo, err := h.client.QueryAuth(event.AuthorizationCode)
    if err != nil {
        return fmt.Errorf("è·å–æ›´æ–°æˆæƒä¿¡æ¯å¤±è´¥: %v", err)
    }
    
    // æ›´æ–°æ•°æ®åº“ä¸­çš„æˆæƒä¿¡æ¯
    err = h.updateAuthorization(authInfo)
    if err != nil {
        return fmt.Errorf("æ›´æ–°æˆæƒä¿¡æ¯å¤±è´¥: %v", err)
    }
    
    fmt.Printf("âœ… æˆæƒæ–¹ %s ä¿¡æ¯å·²æ›´æ–°\n", event.AuthorizerAppid)
    return nil
}

// æ•°æ®åº“æ“ä½œæ–¹æ³•ï¼ˆç¤ºä¾‹ï¼‰
func (h *MyEventHandler) saveAuthorization(authInfo *wego.AuthorizationInfo, authorizerInfo *wego.AuthorizerInfo) error {
    // å®ç°æ•°æ®åº“å­˜å‚¨é€»è¾‘
    return nil
}

func (h *MyEventHandler) cleanupAuthorization(appID string) error {
    // å®ç°æ•°æ®æ¸…ç†é€»è¾‘
    return nil
}

func (h *MyEventHandler) updateAuthorization(authInfo *wego.AuthorizationInfo) error {
    // å®ç°æ•°æ®æ›´æ–°é€»è¾‘
    return nil
}
```

### 2. é›†æˆåˆ°HTTPæœåŠ¡å™¨

```go
func main() {
    config := &wego.WxOpenConfig{
        ComponentAppID:     "your_component_appid",
        ComponentAppSecret: "your_component_appsecret",
        ComponentToken:     "your_component_token",
        EncodingAESKey:     "your_encoding_aes_key",
    }
    
    client := wego.NewWxOpenClient(config)
    
    // è®¾ç½®è‡ªå®šä¹‰äº‹ä»¶å¤„ç†å™¨
    eventHandler := &MyEventHandler{db: yourDB}
    client.SetEventHandler(eventHandler)
    
    // HTTPæ¶ˆæ¯å¤„ç†
    http.HandleFunc("/wego/callback", func(w http.ResponseWriter, r *http.Request) {
        // éªŒè¯ç­¾åå’Œè§£ææ¶ˆæ¯
        signature := r.URL.Query().Get("msg_signature")
        timestamp := r.URL.Query().Get("timestamp")
        nonce := r.URL.Query().Get("nonce")
        
        body, _ := io.ReadAll(r.Body)
        msg, err := client.DecryptMessage(string(body), signature, timestamp, nonce)
        if err != nil {
            http.Error(w, "æ¶ˆæ¯å¤„ç†å¤±è´¥", http.StatusBadRequest)
            return
        }
        
        // å¤„ç†ä¸åŒç±»å‹çš„æ¶ˆæ¯
        var response *wego.MessageResponse
        
        switch msg.InfoType {
        case "authorized", "unauthorized", "updateauthorized":
            response, err = client.HandleAuthorizationEvent(msg)
            
        case "component_verify_ticket":
            response, err = client.HandleVerifyTicket(msg)
            
        default:
            fmt.Printf("æ”¶åˆ°æœªçŸ¥æ¶ˆæ¯ç±»å‹: %s\n", msg.InfoType)
            response = &wego.MessageResponse{ErrCode: 0, ErrMsg: "ok"}
        }
        
        if err != nil {
            http.Error(w, err.Error(), http.StatusInternalServerError)
            return
        }
        
        w.Header().Set("Content-Type", "application/xml")
        w.Write([]byte(response.ToXML()))
    })
    
    http.ListenAndServe(":8080", nil)
}
```

## äº‹ä»¶å¤„ç†æœ€ä½³å®è·µ

### 1. å¹‚ç­‰æ€§å¤„ç†
ç¡®ä¿äº‹ä»¶å¤„ç†æ˜¯å¹‚ç­‰çš„ï¼Œé¿å…é‡å¤å¤„ç†å¯¼è‡´æ•°æ®ä¸ä¸€è‡´ã€‚

### 2. å¼‚æ­¥å¤„ç†
å¯¹äºè€—æ—¶çš„æ“ä½œï¼ˆå¦‚æ•°æ®åº“æ“ä½œã€APIè°ƒç”¨ï¼‰ï¼Œå»ºè®®ä½¿ç”¨å¼‚æ­¥å¤„ç†ã€‚

### 3. é”™è¯¯å¤„ç†
å®ç°å®Œå–„çš„é”™è¯¯å¤„ç†æœºåˆ¶ï¼Œè®°å½•é”™è¯¯æ—¥å¿—ï¼Œç¡®ä¿æœåŠ¡ç¨³å®šæ€§ã€‚

### 4. ç›‘æ§å‘Šè­¦
è®¾ç½®ç›‘æ§å‘Šè­¦ï¼ŒåŠæ—¶å‘ç°å’Œå¤„ç†äº‹ä»¶å¤„ç†å¼‚å¸¸ã€‚

## æ³¨æ„äº‹é¡¹

### 1. æ¶ˆæ¯éªŒè¯
- å§‹ç»ˆéªŒè¯æ¶ˆæ¯ç­¾å
- æ£€æŸ¥æ—¶é—´æˆ³é˜²æ­¢é‡æ”¾æ”»å‡»
- éªŒè¯AppIDåŒ¹é…

### 2. å“åº”è¦æ±‚
- å¿…é¡»åœ¨5ç§’å†…è¿”å›å“åº”
- å“åº”æ ¼å¼å¿…é¡»æ­£ç¡®
- é”™è¯¯æ—¶è¿”å›é€‚å½“çš„é”™è¯¯ç 

### 3. æ•°æ®ä¸€è‡´æ€§
- ç¡®ä¿äº‹ä»¶å¤„ç†çš„æ•°æ®ä¸€è‡´æ€§
- å®ç°äº‹åŠ¡å¤„ç†æœºåˆ¶
- å¤„ç†å¹¶å‘äº‹ä»¶

## å¸¸è§é—®é¢˜

### Q: æ”¶ä¸åˆ°æˆæƒå˜æ›´äº‹ä»¶
A: æ£€æŸ¥æœåŠ¡å™¨é…ç½®ã€ç½‘ç»œè¿æ¥ã€æ¶ˆæ¯ç­¾åéªŒè¯

### Q: äº‹ä»¶å¤„ç†è¶…æ—¶
A: ä¼˜åŒ–å¤„ç†é€»è¾‘ï¼Œå®ç°å¼‚æ­¥å¤„ç†ï¼Œç¡®ä¿5ç§’å†…å“åº”

### Q: é‡å¤äº‹ä»¶å¤„ç†
A: å®ç°å¹‚ç­‰æ€§å¤„ç†ï¼Œæ£€æŸ¥äº‹ä»¶IDæˆ–æ—¶é—´æˆ³

## ç›¸å…³API

- `HandleAuthorizationEvent()` - å¤„ç†æˆæƒå˜æ›´äº‹ä»¶
- `SetEventHandler()` - è®¾ç½®è‡ªå®šä¹‰äº‹ä»¶å¤„ç†å™¨
- `QueryAuth()` - ä½¿ç”¨æˆæƒç è·å–æˆæƒä¿¡æ¯
- `GetAuthorizerInfo()` - è·å–æˆæƒæ–¹è¯¦ç»†ä¿¡æ¯

é€šè¿‡wxopenç»„ä»¶ï¼Œæ‚¨å¯ä»¥è½»æ¾å¤„ç†å„ç§æˆæƒå˜æ›´äº‹ä»¶ï¼Œç¡®ä¿ç¬¬ä¸‰æ–¹å¹³å°æœåŠ¡çš„ç¨³å®šè¿è¡Œã€‚