# 01-授权流程技术说明

## 概述

微信开放平台第三方平台授权流程是第三方平台与公众号/小程序建立授权关系的关键流程。wxopen组件提供了完整的授权流程实现。

## 授权流程步骤

### 1. 获取预授权码

预授权码用于生成授权页面的URL，有效期为20分钟。

```go
// 获取预授权码
preAuthCode, expiresIn, err := client.GetComponentPreAuthCode()
if err != nil {
    // 处理错误
}

fmt.Printf("预授权码: %s, 有效期: %d秒\n", preAuthCode, expiresIn)
```

### 2. 生成授权页面URL

使用预授权码生成授权页面URL，引导用户进行授权。

```go
// 生成授权页面URL
authURL := client.GetComponentLoginPage(preAuthCode, "your_redirect_uri")
fmt.Printf("授权页面URL: %s\n", authURL)
```

### 3. 处理授权回调

用户授权后，微信会回调到指定的redirect_uri，并携带授权码。

```go
// 处理授权回调
authCode := "从回调URL中获取的授权码"
authorizationInfo, err := client.QueryAuth(authCode)
if err != nil {
    // 处理错误
}

fmt.Printf("授权方AppID: %s\n", authorizationInfo.AuthorizerAppid)
fmt.Printf("授权方AccessToken: %s\n", authorizationInfo.AuthorizerAccessToken)
fmt.Printf("授权方RefreshToken: %s\n", authorizationInfo.AuthorizerRefreshToken)
```

### 4. 获取授权方信息

获取授权方的详细信息，包括昵称、头像、服务类型等。

```go
// 获取授权方信息
authorizerInfo, err := client.GetAuthorizerInfo(authorizationInfo.AuthorizerAppid)
if err != nil {
    // 处理错误
}

fmt.Printf("授权方昵称: %s\n", authorizerInfo.NickName)
fmt.Printf("授权方头像: %s\n", authorizerInfo.HeadImg)
fmt.Printf("服务类型: %d\n", authorizerInfo.ServiceTypeInfo.ID)
```

## wxopen组件实现

### 核心结构体

```go
// WxOpenClient 第三方平台客户端
type WxOpenClient struct {
    config *WxOpenConfig
    storage TokenStorage
}

// AuthorizerClient 授权方客户端
type AuthorizerClient struct {
    appID string
    client *WxOpenClient
}
```

### 配置说明

```go
type WxOpenConfig struct {
    ComponentAppID     string // 第三方平台AppID
    ComponentAppSecret string // 第三方平台AppSecret
    ComponentToken     string // 第三方平台Token
    EncodingAESKey     string // 消息加解密密钥
    RedirectURI        string // 授权回调地址
}
```

## 完整示例

```go
package main

import (
    "fmt"
    "github.com/jcbowen/jcbaseGo/component/wego"
)

func main() {
    // 1. 初始化客户端
    config := &wego.WxOpenConfig{
        ComponentAppID:     "your_component_appid",
        ComponentAppSecret: "your_component_appsecret",
        ComponentToken:     "your_component_token", 
        EncodingAESKey:     "your_encoding_aes_key",
        RedirectURI:        "https://yourdomain.com/auth/callback",
    }
    
    client := wego.NewWxOpenClient(config)
    
    // 2. 获取预授权码
    preAuthCode, expiresIn, err := client.GetComponentPreAuthCode()
    if err != nil {
        fmt.Printf("获取预授权码失败: %v\n", err)
        return
    }
    
    // 3. 生成授权页面URL
    authURL := client.GetComponentLoginPage(preAuthCode, config.RedirectURI)
    fmt.Printf("请访问以下URL进行授权: %s\n", authURL)
    
    // 4. 处理授权回调（在实际应用中，这通常在HTTP处理函数中）
    // authCode := r.URL.Query().Get("auth_code")
    // authorizationInfo, err := client.QueryAuth(authCode)
    // ...
}
```

## 注意事项

1. **预授权码有效期**：预授权码有效期为20分钟，需要及时使用
2. **授权回调处理**：确保回调地址可公开访问且正确处理HTTPS
3. **Token管理**：授权方AccessToken有效期为2小时，需要定时刷新
4. **安全考虑**：妥善保管ComponentAppSecret和EncodingAESKey

## 常见问题

### Q: 授权页面显示"redirect_uri参数错误"
A: 请检查在微信开放平台配置的授权回调域名与代码中使用的redirect_uri是否一致

### Q: 获取预授权码失败
A: 请检查ComponentAppID和ComponentAppSecret是否正确，以及网络连接是否正常

### Q: 授权回调处理失败
A: 请检查回调处理逻辑是否正确，以及授权码是否在有效期内

## 相关API

- `GetComponentPreAuthCode()` - 获取预授权码
- `GetComponentLoginPage()` - 生成授权页面URL  
- `QueryAuth()` - 使用授权码换取授权信息
- `GetAuthorizerInfo()` - 获取授权方详细信息
- `GetAuthorizerOption()` - 获取授权方选项设置
- `SetAuthorizerOption()` - 设置授权方选项

通过wxopen组件，您可以轻松实现完整的微信开放平台第三方平台授权流程。